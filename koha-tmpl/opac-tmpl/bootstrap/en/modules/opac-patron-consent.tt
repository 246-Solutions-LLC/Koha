[% USE raw %]
[% USE Koha %]
[% USE KohaDates %]
[% USE AdditionalContents %]
[% SET OpacNav = AdditionalContents.get( location => "OpacNav", lang => lang, library => logged_in_user.branchcode || default_branch, blocktitle => 0 ) %]
[% SET OpacNavBottom = AdditionalContents.get( location => "OpacNavBottom", lang => lang, library => logged_in_user.branchcode || default_branch, blocktitle => 0 ) %]
[% SET consentview = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>Your consents &rsaquo; [% IF ( LibraryNameTitle ) %][% LibraryNameTitle | html %][% ELSE %]Koha online[% END %] catalog</title>
[% INCLUDE 'doc-head-close.inc' %]
[% BLOCK cssinclude %][% END %]
</head>
[% INCLUDE 'bodytag.inc' bodyid='opac-patron-consent' %]
[% INCLUDE 'masthead.inc' %]

<div class="main">
    [% WRAPPER breadcrumbs %]
        [% WRAPPER breadcrumb_item %]
            <a href="/cgi-bin/koha/opac-user.pl">[% patron.firstname | html %] [% patron.surname | html %]</a>
        [% END %]
        [% WRAPPER breadcrumb_item bc_active= 1 %]
            <span>Your consents</span>
        [% END %]
    [% END #/ WRAPPER breadcrumbs %]

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-2">
                <div id="navigation">
                    [% INCLUDE 'navigation.inc' IsPatronPage=1 %]
                </div>
            </div>
            <div class="col-lg-10 order-first order-md-first order-lg-2">
                <div id="patronconsents" class="maincontent">
                    <form action="/cgi-bin/koha/opac-patron-consent.pl" method="post">
                        <input type="hidden" name="op" value="save"/>
                        <input type="hidden" name="borrowernumber" value="[% patron.borrowernumber | html %]"/>
                        <h1>Your consents</h1>
                        <br>
                        [% FOREACH consent IN consents %]
                            [% SET consent_type = consent.type %]
                            [% IF consent_type == 'GDPR_PROCESSING' %]
                                <legend><h2>Privacy policy consent</h2></legend>
                                <p>Please read the <a target="_blank" href="[% Koha.Preference('PrivacyPolicyURL') | url %]">privacy policy</a>.</p>
                                <p>In order to keep you logged in, we need your consent to process personal data as specified in the EU General Data Protection Regulation of May 25, 2018. If you would not agree, we will need to <strong>remove</strong> your account within a reasonable time.</p>
                                <p>Do you agree with our processing of your personal data as outlined in the policy?</p>
                            [% ELSIF consent_types.$consent_type %]
                                [% SET consent_title = ( consent_types.$consent_type.title.$lang || consent_types.$consent_type.title.en ) %]
                                [% SET consent_desc  = ( consent_types.$consent_type.description.$lang || consent_types.$consent_type.description.en )  %]
                                <legend><h2>[% consent_title | html %]</h2></legend>
                                <p>[% consent_desc | html %]</p>
                                <p>Do you agree?</p>
                            [% ELSE %]
                                <legend><h2>Consent for [% consent_type | html %]</h2></legend>
                                <p>Do you agree?</p>
                            [% END %]
                            <fieldset>
                                <input type="radio" name="check_[% consent_type | html %]" value="1"> Yes<br>
                                <input type="radio" name="check_[% consent_type | html %]" value="0"> No
                            </fieldset>
                            [% IF consent.given_on %]
                                <p class="consent_info">Your consent was registered on [% consent.given_on | html %].</p>
                            [% ELSIF consent.refused_on %]
                                <p class="dissent_info">We registered that you did not consent on [% consent.refused_on | html %].</p>
                            [% END %]
                            <br>
                        [% END %]
                        <fieldset class="action">
                            <input id="saveconsent" type="submit" value="Save" class="btn btn-primary" />
                        </fieldset>
                    </form>

                    [% IF Koha.Preference('CookieConsent') %]
                        <h2>Cookie consents</h2>
                        <button id="viewCookieConsents" type="button" class="btn btn-success">View your cookie consents</button>
                    [% END %]

                </div> <!-- / #patronconsents -->
            </div> <!-- / .col-lg-10 -->
        </div> <!-- / .row -->
    </div> <!-- / .container-fluid -->
</div> <!-- / .main -->

[% INCLUDE 'opac-bottom.inc' %]
[% BLOCK jsinclude %]
    <script>
        $(document).ready(function() {
            [% FOREACH consent IN consents %]
                [% IF consent.given_on %]
                    $("input[type='radio'][name='check_[% consent.type | html %]'][value='1']").prop('checked',true);
                [% ELSIF consent.refused_on %]
                    $("input[type='radio'][name='check_[% consent.type | html %]'][value='0']").prop('checked',true);
                 [% END %]
            [% END %]
            // Initially no choice is made or no change, so disable button
            $("#saveconsent").prop('disabled', true);

            $("input[type='radio']").click(function() {
                $("#saveconsent").prop('disabled', false);
                var v = $(this).val();
                // If former registration info present, toggle
                if( v == 1 ) {
                    $(this).parent().siblings('.consent_info').show();
                    $(this).parent().siblings('.dissent_info').hide();
                } else {
                    $(this).parent().siblings('.consent_info').hide();
                    $(this).parent().siblings('.dissent_info').show();
                }
            });
        });
    </script>
[% END %]
